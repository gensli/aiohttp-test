Тестовый сервер aiohttp с очередью задач и RabbitMQ в качестве брокера
===

В состав входит три отдельных сервиса: http сервер, websocket сервер и очередь задач. Брокером сообщений выступает RabbitMQ. Запуск через докер.

Принцип работы:
* клиент передает некий текст через запрос на http сервер
* сервер отправляет сообщение в брокер
* очередь задач забирает сообщение из брокера и вызывает обработчик
* обработчик переворачивает делает паузу (для наглядности) по длинее текста, затем переворачивает его и отсылает на сокет сервер
* сокет сервер получает сообщение и рассылает его всем подключенным клиентам


Требования
---
* Python 3.7+
* Docker 1.13.0+

Установка
---

* Виртуальное окружение для тестирования сервисов:
```
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

* Запуск сервисов:

```
docker-compose --compatibility up -d
```

Флаг ```--compatibility``` необходим для поддержки репликации с командой ```up```.

В конфигурации ```docker-compose.yml``` можно задать количество реплик для сервиса ```message_queue``` (по умолчанию 2).
Для сервисов ```api_server``` и ```socket_server``` можно задать количество хостов через флаг ```--sites``` для воркера: ```python aiohttp_test/api_server_worker.py --sites 2```. При этом важно не забыть пробросить соответствующие порты по принципу ```808{i}```, где ```i``` — порядковый номер в пределах требуемого количества хостов. В конфигурации для ```api_server``` указано запускать два хоста, а для ```socket_server``` один.


Использование
---

* Для получения сообщений:

```
python aiohttp_test/listen_results.py
```
Если клиент успешно подключился к серверу, появится сообщение:
```
Salut, let's wait some text...
```
Обработанный текст будет появляться в консоли по мере обработки.

* Для отправки сообщений:
```
python aiohttp_test/queue_reverse_text.py --text abcdef
```
Если сервер успешно получил текст, появится сообщение:
```
Got it
```
Скрипт отправит указаный через флаг ```--text``` текст в брокер сообщений, оттуда сообщение с текстом попадет в обработчик, который сделает паузу в зависимости от длины текста и перешлет перевернутый текст на сокет сервер, откуда он уже попадет всем подключенным клиентам.